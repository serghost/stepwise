<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= step.title %> | Stepwise</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <div class="page">
    <nav class="nav">
      <div class="container nav-inner">
        <a href="/dashboard" class="nav-brand">
          üìö <span>Stepwise</span>
        </a>
        <div class="nav-user">
          <span class="nav-user-name"><%= user.name %></span>
          <a href="/logout" class="btn btn-secondary btn-sm">–í—ã–π—Ç–∏</a>
        </div>
      </div>
    </nav>
    
    <main class="main">
      <div class="container" style="max-width: 800px;">
        <div class="breadcrumb">
          <a href="/dashboard">–ú–æ–∏ –∫—É—Ä—Å—ã</a>
          <span class="breadcrumb-sep">‚Üí</span>
          <a href="/course/<%= course.id %>"><%= course.title %></a>
          <span class="breadcrumb-sep">‚Üí</span>
          <span><%= step.title %></span>
        </div>
        
        <div class="page-header">
          <h1 class="page-title"><%= step.title %></h1>
          <p class="page-subtitle">–°—Ç–µ–ø <%= step.position %></p>
        </div>
        
        <% if (typeof query !== 'undefined' && query.success === 'submitted') { %>
          <div class="alert alert-success">
            ‚úÖ –ó–∞–¥–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É! –ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å —Å–∫–æ—Ä–æ –µ–≥–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç.
          </div>
        <% } %>
        
        <% if (typeof query !== 'undefined' && query.error === 'no_file') { %>
          <div class="alert alert-error">
            ‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Ñ–∞–π–ª.
          </div>
        <% } %>

        <% if (typeof query !== 'undefined' && query.error === 'no_text') { %>
          <div class="alert alert-error">
            ‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç.
          </div>
        <% } %>

        <% if (typeof query !== 'undefined' && query.error === 'empty') { %>
          <div class="alert alert-error">
            ‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –ø–æ–ª–µ –æ—Ç–≤–µ—Ç–∞.
          </div>
        <% } %>
        
        <% if (step.content) { %>
          <div class="step-content-body">
            <%- step.content.replace(/\n/g, '<br>') %>
          </div>
        <% } %>
        
        <% if (step.video_url) { %>
          <div class="card" style="margin-bottom: 1.5rem;">
            <h3 style="margin-bottom: 1rem;">üìπ –í–∏–¥–µ–æ —É—Ä–æ–∫–∞</h3>
            <div class="video-container">
              <video controls style="width: 100%;">
                <source src="<%= step.video_url %>" type="video/mp4">
              </video>
            </div>
          </div>
        <% } %>
        
        <% if (progress.status === 'rejected' && progress.admin_comment) { %>
          <div class="comment-box">
            <div class="comment-box-title">
              ‚ö†Ô∏è –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è
            </div>
            <div class="comment-box-text">
              <%= progress.admin_comment %>
            </div>
          </div>
        <% } %>
        
        <% if (progress.status === 'completed') { %>
          <div class="alert alert-success">
            ‚úÖ –≠—Ç–æ—Ç —Å—Ç–µ–ø –≤—ã–ø–æ–ª–Ω–µ–Ω! –í—ã –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ–π—Ç–∏ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É.
          </div>
          
          <% if (progress.file_url || progress.text_answer) { %>
            <div class="card">
              <h3 style="margin-bottom: 1rem;">–í–∞—à –æ—Ç–≤–µ—Ç</h3>
              <% if (progress.text_answer) { %>
                <div class="answer-text" style="background: var(--bg-tertiary); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                  <%- progress.text_answer.replace(/\n/g, '<br>') %>
                </div>
              <% } %>
              <% if (progress.file_url) { %>
                <% if (progress.file_url.match(/\.(mp4|webm|mov)$/i)) { %>
                  <div class="video-container">
                    <video controls>
                      <source src="<%= progress.file_url %>" type="video/mp4">
                    </video>
                  </div>
                <% } else { %>
                  <a href="<%= progress.file_url %>" target="_blank" class="btn btn-secondary">
                    üìé –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª
                  </a>
                <% } %>
              <% } %>
            </div>
          <% } %>

          <div style="margin-top: 1.5rem;">
            <a href="/course/<%= course.id %>" class="btn btn-primary">
              ‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∫—É—Ä—Å—É
            </a>
          </div>
        <% } else if (progress.status === 'pending') { %>
          <div class="alert alert-warning">
            ‚è≥ –í–∞—à–µ –∑–∞–¥–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∏ –æ–∂–∏–¥–∞–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–º.
          </div>

          <% if (progress.file_url || progress.text_answer) { %>
            <div class="card">
              <h3 style="margin-bottom: 1rem;">–í–∞—à –æ—Ç–≤–µ—Ç</h3>
              <% if (progress.text_answer) { %>
                <div class="answer-text" style="background: var(--bg-tertiary); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                  <%- progress.text_answer.replace(/\n/g, '<br>') %>
                </div>
              <% } %>
              <% if (progress.file_url) { %>
                <% if (progress.file_url.match(/\.(mp4|webm|mov)$/i)) { %>
                  <div class="video-container">
                    <video controls>
                      <source src="<%= progress.file_url %>" type="video/mp4">
                    </video>
                  </div>
                <% } else { %>
                  <a href="<%= progress.file_url %>" target="_blank" class="btn btn-secondary">
                    üìé –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª
                  </a>
                <% } %>
              <% } %>
            </div>
          <% } %>

          <div style="margin-top: 1.5rem;">
            <a href="/course/<%= course.id %>" class="btn btn-secondary">
              ‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∫—É—Ä—Å—É
            </a>
          </div>
        <% } else if (step.step_type === 'info') { %>
          <div class="alert alert-success">
            ‚úÖ –ú–∞—Ç–µ—Ä–∏–∞–ª –∏–∑—É—á–µ–Ω! –ú–æ–∂–µ—Ç–µ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Å—Ç–µ–ø—É.
          </div>
          <div style="margin-top: 1.5rem;">
            <a href="/course/<%= course.id %>" class="btn btn-primary">
              ‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∫—É—Ä—Å—É
            </a>
          </div>
        <% } else { %>
          <% const answerType = step.answer_type || 'file'; %>
          <% const needsText = answerType.includes('text'); %>
          <% const needsFile = answerType.includes('file'); %>

          <div class="card">
            <h3 style="margin-bottom: 1rem;">üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞</h3>

            <form method="POST" action="/step/<%= step.id %>/submit" enctype="multipart/form-data" id="uploadForm">
              <% if (needsText) { %>
                <div class="form-group">
                  <label class="form-label">–¢–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç</label>
                  <textarea name="text_answer" class="form-textarea" rows="6" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –æ—Ç–≤–µ—Ç..."><%= progress.text_answer || '' %></textarea>
                </div>
              <% } %>

              <% if (needsFile) { %>
                <div class="form-group">
                  <label class="form-label">–§–∞–π–ª / –≤–∏–¥–µ–æ</label>
                  <label class="file-upload" for="fileInput" id="fileUploadLabel">
                    <div class="file-upload-icon">üìπ</div>
                    <div class="file-upload-text" id="fileName">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</div>
                    <div class="file-upload-hint">MP4, MOV, AVI, WebM, PDF, DOC, ZIP ‚Äî –¥–æ 500 –ú–ë</div>
                    <input type="file" id="fileInput" name="file" accept=".mp4,.mov,.avi,.webm,.mkv,.pdf,.doc,.docx,.zip" <%= needsFile && !needsText ? 'required' : '' %>>
                  </label>
                </div>
              <% } %>

              <div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
                <button type="submit" class="btn btn-primary" id="submitBtn">
                  –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É
                </button>
                <a href="/course/<%= course.id %>" class="btn btn-secondary">
                  –û—Ç–º–µ–Ω–∞
                </a>
              </div>
            </form>
          </div>
        <% } %>
      </div>
    </main>
  </div>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const fileInput = document.getElementById('fileInput');
      const fileName = document.getElementById('fileName');
      const submitBtn = document.getElementById('submitBtn');
      const fileUploadLabel = document.getElementById('fileUploadLabel');
      const uploadForm = document.getElementById('uploadForm');
      
      if (fileInput) {
        fileInput.addEventListener('change', function() {
          if (this.files.length > 0) {
            const file = this.files[0];
            const sizeMB = (file.size / 1024 / 1024).toFixed(1);
            fileName.textContent = `‚úì ${file.name} (${sizeMB} –ú–ë)`;
            fileUploadLabel.classList.add('has-file');
          } else {
            fileName.textContent = '–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª';
            fileUploadLabel.classList.remove('has-file');
          }
        });
      }
      
      if (uploadForm) {
        uploadForm.addEventListener('submit', function() {
          if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
          }
        });
      }
    });
  </script>
</body>
</html>
